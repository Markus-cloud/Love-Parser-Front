global:
  resolve_timeout: 5m

route:
  receiver: slack-notifications
  group_by: [alertname, severity]
  routes:
    - matchers:
        - severity="critical"
      receiver: email-critical
    - matchers:
        - severity="critical"
      receiver: pagerduty-escalation
    - matchers:
        - notify_sms="true"
      receiver: sms-escalation

receivers:
  - name: slack-notifications
    slack_configs:
      - api_url: ${SLACK_WEBHOOK_URL}
        channel: ${SLACK_CHANNEL:-#love-parser-alerts}
        send_resolved: true
        title: "[{{ .Status | toUpper }}] {{ .CommonLabels.alertname }}"
        text: |
          *Severity:* {{ .CommonLabels.severity }}
          *Summary:* {{ .CommonAnnotations.summary }}
          *Description:* {{ .CommonAnnotations.description }}
          *Runbook:* {{ .CommonAnnotations.runbook }}

  - name: email-critical
    email_configs:
      - to: ${ALERT_EMAIL_TO}
        from: ${ALERT_EMAIL_FROM}
        smarthost: ${SMTP_HOST}
        auth_username: ${SMTP_USERNAME}
        auth_password: ${SMTP_PASSWORD}
        require_tls: true
        send_resolved: true

  - name: pagerduty-escalation
    pagerduty_configs:
      - routing_key: ${PAGERDUTY_ROUTING_KEY}
        severity: critical
        send_resolved: true

  - name: sms-escalation
    webhook_configs:
      - url: ${SMS_WEBHOOK_URL}
        http_config:
          bearer_token: ${SMS_API_TOKEN}
        send_resolved: true
